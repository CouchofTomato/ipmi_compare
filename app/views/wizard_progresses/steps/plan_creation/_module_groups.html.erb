<% plan = progress.subject %>
<% module_group = local_assigns[:resource].is_a?(ModuleGroup) ? local_assigns[:resource] : ModuleGroup.new %>
<% existing_module_groups = plan&.module_groups.to_a %>
<% next_position = (plan&.module_groups&.maximum(:position) || -1) + 1 %>
<% input_classes = "block w-full rounded-md border-0 bg-white px-3 py-2 text-base text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:ring-white/10 dark:placeholder:text-gray-500 dark:focus:ring-indigo-500" %>

<%= turbo_frame_tag "wizard_step" do %>
  <div class="space-y-6">
    <div>
      <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Step 4: Module groups</h2>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">Group plan modules into logical buckets (e.g., Core, Optional riders) so brokers can understand how modules are organised.</p>
    </div>

    <% has_errors = (module_group.respond_to?(:errors) && module_group.errors.any?) || progress.errors.any? %>
    <% if has_errors %>
      <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700 shadow-xs dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-200">
        <p class="font-semibold">We couldn't save this module group</p>
        <ul class="mt-2 list-disc space-y-1 pl-4">
          <% if module_group.respond_to?(:errors) && module_group.errors.any? %>
            <% module_group.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          <% end %>
          <% progress.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with url: wizard_progress_path(progress),
                  method: :patch,
                  data: { turbo_frame: "wizard_step" },
                  local: true,
                  html: { class: "space-y-6" } do |form| %>
      <div class="space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-white/10 dark:bg-gray-900">
        <div>
          <%= form.label :name, "Module group name", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
          <div class="mt-2">
            <%= form.text_field :name, name: "module_groups[name]", class: input_classes, placeholder: "e.g. Core benefits", data: { test_id: "module-group-name-field" } %>
          </div>
          <% if module_group.errors[:name].present? %>
            <p class="mt-2 text-sm text-red-600 dark:text-red-400"><%= module_group.errors[:name].to_sentence %></p>
          <% end %>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <%= form.label :description, class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.text_area :description,
                                 name: "module_groups[description]",
                                 class: "#{input_classes} min-h-[120px]",
                                 placeholder: "Optional context that explains what's included in this group.",
                                 data: { test_id: "module-group-description-field" } %>
            </div>
          </div>

          <div>
            <%= form.label :position, class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.number_field :position,
                                    name: "module_groups[position]",
                                    value: next_position,
                                    min: 0,
                                    class: input_classes,
                                    data: { test_id: "module-group-position-field" } %>
            </div>
            <% if module_group.errors[:position].present? %>
              <p class="mt-2 text-sm text-red-600 dark:text-red-400"><%= module_group.errors[:position].to_sentence %></p>
            <% end %>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-3 border-t border-gray-200 pt-6 sm:flex-row sm:items-center sm:justify-between dark:border-white/10">
        <div class="flex gap-3">
          <%= button_tag "← Back",
                         name: "step_action",
                         value: "previous",
                         class: "inline-flex items-center gap-1 rounded-md border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:border-white/10 dark:text-gray-200 dark:hover:bg-white/10 dark:focus:ring-indigo-500" %>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <%= button_tag "Add module group",
                         name: "step_action",
                         value: "add",
                         class: "inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-xs transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:bg-indigo-500 dark:hover:bg-indigo-400",
                         data: { test_id: "add-module-group-button" } %>
          <%= button_tag "Save and continue →",
                         name: "step_action",
                         value: "next",
                         class: "inline-flex items-center gap-2 rounded-md border border-transparent px-4 py-2 text-sm font-semibold text-indigo-700 bg-indigo-50 shadow-xs hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:bg-indigo-600/20 dark:text-indigo-100 dark:hover:bg-indigo-600/30",
                         data: { test_id: "next-step-button" } %>
        </div>
      </div>
    <% end %>

    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Module groups added</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400"><%= pluralize(existing_module_groups.size, "group") %></p>
      </div>

      <% if existing_module_groups.empty? %>
        <div class="rounded-lg border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 shadow-xs dark:border-white/20 dark:bg-gray-900 dark:text-gray-300">
          No module groups yet. Add your first group to continue.
        </div>
      <% else %>
        <div class="grid gap-4 sm:grid-cols-2">
          <% existing_module_groups.each do |group| %>
            <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm dark:border-white/10 dark:bg-gray-900">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400">Position <span class="font-semibold text-gray-900 dark:text-gray-100"><%= group.position %></span></p>
                  <p class="mt-1 text-base font-semibold text-gray-900 dark:text-gray-100"><%= group.name %></p>
                </div>
              </div>
              <% if group.description.present? %>
                <p class="mt-3 text-sm text-gray-600 dark:text-gray-300"><%= simple_format(group.description) %></p>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
