<% rule = rule_form.object %>
<% input_classes = local_assigns.fetch(:field_input_classes) %>
<% limit_options = local_assigns.fetch(:limit_type_options) %>
<% scope_options = local_assigns.fetch(:scope_options) %>
<% current_limit_type = rule.limit_type.presence || "amount" %>
<% amount_hidden = current_limit_type == "amount" ? "" : "hidden" %>
<% cap_hidden = current_limit_type == "not_stated" ? "hidden" : "" %>
<% persisted_rule = rule.persisted? %>

<div class="rounded-lg border border-gray-200 bg-white p-4 dark:border-white/10 dark:bg-gray-900"
     data-benefit-limit-rules-target="row"
     data-new-record="<%= persisted_rule ? "false" : "true" %>">
  <%= rule_form.hidden_field :id if persisted_rule %>
  <%= rule_form.hidden_field :_destroy, value: "0", data: { benefit_limit_rules_target: "destroyField" } %>

  <div class="mb-3">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Limit rule</p>
  </div>

  <div class="grid gap-3 sm:grid-cols-3">
    <div>
      <%= rule_form.label :scope, "Scope", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.select :scope, scope_options, {}, class: input_classes, data: { test_id: "benefit-limit-rule-scope-field" } %>
    </div>

    <div>
      <%= rule_form.label :name, "Name", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.text_field :name,
                               class: input_classes,
                               placeholder: "e.g. X-ray or Physiotherapy",
                               data: { test_id: "benefit-limit-rule-name-field" } %>
    </div>

    <div>
      <%= rule_form.label :limit_type, "Type", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.select :limit_type,
                           limit_options,
                           {},
                           class: input_classes,
                           data: {
                             action: "change->benefit-limit-rules#toggleLimitType",
                             benefit_limit_rules_target: "limitType",
                             test_id: "benefit-limit-rule-type-field"
                           } %>
    </div>
  </div>

  <div class="mt-3 grid gap-3 sm:grid-cols-3 <%= amount_hidden %>" data-benefit-limit-rules-target="amountFields">
    <div>
      <%= rule_form.label :insurer_amount_usd, "Insurer amount USD", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.number_field :insurer_amount_usd, class: input_classes, step: 0.01, min: 0 %>
    </div>
    <div>
      <%= rule_form.label :insurer_amount_gbp, "Insurer amount GBP", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.number_field :insurer_amount_gbp, class: input_classes, step: 0.01, min: 0 %>
    </div>
    <div>
      <%= rule_form.label :insurer_amount_eur, "Insurer amount EUR", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.number_field :insurer_amount_eur, class: input_classes, step: 0.01, min: 0 %>
    </div>
  </div>

  <div class="mt-3 grid gap-3 sm:grid-cols-3">
    <div data-benefit-limit-rules-target="unitField" class="<%= amount_hidden %>">
      <%= rule_form.label :unit, "Insurer amount unit", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.text_field :unit, class: input_classes, placeholder: "e.g. per session" %>
    </div>

    <div>
      <%= rule_form.label :position, "Position", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.number_field :position, class: input_classes, min: 0, step: 1 %>
    </div>
  </div>

  <div class="mt-3 grid gap-3 sm:grid-cols-4 <%= cap_hidden %>" data-benefit-limit-rules-target="capFields">
    <div>
      <%= rule_form.label :cap_insurer_amount_usd, "Cap (insurer amount) USD", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.number_field :cap_insurer_amount_usd, class: input_classes, step: 0.01, min: 0 %>
    </div>
    <div>
      <%= rule_form.label :cap_insurer_amount_gbp, "Cap (insurer amount) GBP", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.number_field :cap_insurer_amount_gbp, class: input_classes, step: 0.01, min: 0 %>
    </div>
    <div>
      <%= rule_form.label :cap_insurer_amount_eur, "Cap (insurer amount) EUR", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.number_field :cap_insurer_amount_eur, class: input_classes, step: 0.01, min: 0 %>
    </div>
    <div>
      <%= rule_form.label :cap_unit, "Cap unit", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
      <%= rule_form.text_field :cap_unit, class: input_classes, placeholder: "e.g. per policy year" %>
    </div>
  </div>

  <div class="mt-3">
    <%= rule_form.label :notes, "Notes (optional)", class: "text-xs font-semibold text-gray-900 dark:text-gray-100" %>
    <%= rule_form.text_area :notes, class: "#{input_classes} min-h-[80px]", placeholder: "Additional context" %>
  </div>

  <div class="mt-3 flex justify-end">
    <button type="button"
            data-action="benefit-limit-rules#removeRow"
            class="inline-flex items-center gap-2 rounded-md border border-red-300 px-3 py-2 text-xs font-semibold text-red-700 hover:bg-red-50 dark:border-red-400/40 dark:text-red-300 dark:hover:bg-red-900/20"
            data-test-id="remove-benefit-limit-rule-button">
      Remove rule
    </button>
  </div>
</div>
