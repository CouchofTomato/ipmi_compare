<% plan = progress.subject || Plan.new %>
<% plan_version = progress.plan_version || plan.current_plan_version %>
<% residency_resource = local_assigns[:resource] %>
<% selected_country_codes =
     case residency_resource
     when Hash
       Array(residency_resource[:country_codes] || residency_resource["country_codes"])
     when Plan
       plan_version&.plan_residency_eligibilities&.map(&:country_code) || []
     else
       plan_version&.plan_residency_eligibilities&.map(&:country_code) || []
     end
%>
<% countries_by_region = ISO3166::Country.all.each_with_object(Hash.new { |hash, key| hash[key] = [] }) do |country, memo|
     next if country.alpha2.blank?
     region_name = country.region.presence || "Other"
     memo[region_name] << country
   end
%>

<%= turbo_frame_tag "wizard_step" do %>
  <div class="space-y-6">
    <div>
      <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Step 2: Residency eligibility</h2>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
        Choose the countries where applicants can reside. You can toggle entire regions or individual countries as needed.
      </p>
    </div>

    <% if progress.errors.any? %>
      <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700 shadow-xs dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-200">
        <p class="font-semibold">We couldn't save these residency details</p>
        <ul class="mt-2 list-disc space-y-1 pl-4">
          <% progress.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with url: wizard_progress_path(progress),
                  method: :patch,
                  data: { turbo_frame: "wizard_step" },
                  html: { class: "space-y-8" } do %>
      <div class="space-y-8" data-controller="residency-selector">
        <% countries_by_region.sort_by { |region_name, _| region_name }.each do |region_name, countries| %>
          <% region_key = region_name.parameterize.presence || "other" %>
          <% country_list_id = "residency_region_#{region_key}_countries" %>
          <fieldset class="space-y-4 rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-white/10 dark:bg-gray-900" data-residency-selector-target="region" data-region="<%= region_key %>">
            <legend class="flex flex-wrap items-center justify-between gap-3 text-base font-semibold text-gray-900 dark:text-gray-100">
              <div class="flex items-center gap-3">
                <button type="button"
                        class="inline-flex items-center gap-2 rounded-md border border-gray-300 px-3 py-1 text-xs font-medium text-gray-700 shadow-xs transition hover:border-indigo-400 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:border-white/10 dark:text-gray-200 dark:hover:border-indigo-300 dark:focus:ring-indigo-500"
                        data-action="residency-selector#toggleCountries"
                        data-residency-selector-target="toggleButton"
                        data-region="<%= region_key %>"
                        aria-controls="<%= country_list_id %>"
                        aria-expanded="false">
                  <%= inline_svg_tag "plus-circle.svg",
                                     class: "h-5 w-5 text-indigo-600 dark:text-indigo-400",
                                     data: { role: "expand-icon" },
                                     aria: { hidden: true } %>
                  <%= inline_svg_tag "minus-circle.svg",
                                     class: "h-5 w-5 text-indigo-600 dark:text-indigo-400 hidden",
                                     data: { role: "collapse-icon" },
                                     aria: { hidden: true } %>
                  <span class="sr-only">Toggle countries</span>
                </button>
                <span><%= region_name %> <span class="ml-1 text-sm font-normal text-gray-500 dark:text-gray-400">(<%= countries.size %>)</span></span>
              </div>
              <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-200">
                <input type="checkbox"
                       class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                       data-action="change->residency-selector#toggleRegion"
                       data-residency-selector-target="regionCheckbox"
                       data-region="<%= region_key %>">
                Select all
              </label>
            </legend>

            <div id="<%= country_list_id %>" class="hidden grid gap-3 sm:grid-cols-2 lg:grid-cols-3" data-residency-selector-target="countryList" data-region="<%= region_key %>">
              <% countries.sort_by { |country| country.translations["en"] || country.common_name || country.iso_short_name || country.name }.each do |country| %>
                <% country_code = country.alpha2 %>
                <% country_name = country.translations["en"] || country.common_name || country.iso_short_name || country.name %>
                <label class="flex items-start gap-3 rounded-lg border border-gray-200 px-3 py-2 text-sm text-gray-700 shadow-xs transition hover:border-indigo-300 hover:bg-indigo-50/50 dark:border-white/10 dark:text-gray-200 dark:hover:border-indigo-400/60 dark:hover:bg-indigo-500/10" data-region="<%= region_key %>">
                  <%= check_box_tag "residency[country_codes][]",
                                     country_code,
                                     selected_country_codes.include?(country_code),
                                     id: "residency_country_#{country_code.downcase}",
                                     class: "mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500",
                                     data: { action: "change->residency-selector#syncRegion", region: region_key, residency_selector_target: "countryCheckbox" } %>
                  <span>
                    <span class="font-medium"><%= country_name %></span>
                    <span class="block text-xs text-gray-500 dark:text-gray-400"><%= country.alpha2 %></span>
                  </span>
                </label>
              <% end %>
            </div>
          </fieldset>
        <% end %>
      </div>

      <div class="flex flex-col gap-3 border-t border-gray-200 pt-6 sm:flex-row sm:items-center sm:justify-between dark:border-white/10">
        <div>
          <%= button_tag "← Back",
                         name: "step_action",
                         value: "previous",
                         class: "inline-flex items-center gap-1 rounded-md border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:border-white/10 dark:text-gray-200 dark:hover:bg-white/10 dark:focus:ring-indigo-500" %>
        </div>
        <%= button_tag "Save and continue →",
                       name: "step_action",
                       value: "next",
                       class: "inline-flex items-center gap-1 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-xs hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:bg-indigo-500 dark:hover:bg-indigo-400",
                       data: { test_id: "next-step-button" } %>
      </div>
    <% end %>
  </div>
<% end %>
