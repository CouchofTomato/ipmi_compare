<% plan = progress.subject %>
<% plan_version = progress.plan_version || plan&.current_plan_version %>
<% module_benefit = local_assigns[:resource].is_a?(ModuleBenefit) ? local_assigns[:resource] : ModuleBenefit.new %>
<% available_modules = plan_version&.plan_modules&.joins(:module_group)&.includes(:module_group)&.order("module_groups.position ASC", "plan_modules.created_at ASC") || [] %>
<% available_benefits = Benefit.includes(:coverage_category).order(:name) %>
<% existing_benefits = ModuleBenefit.where(plan_module_id: Array(plan_version&.plan_module_ids)).includes(:benefit_limit_rules, benefit: :coverage_category, plan_module: :module_group, benefit_limit_group: {}).order(:plan_module_id, :weighting, :created_at) %>
<% grouped_benefits = existing_benefits.group_by(&:plan_module_id) %>
<% input_classes = "block w-full rounded-md border-0 bg-white px-3 py-2 text-base text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:ring-white/10 dark:placeholder:text-gray-500 dark:focus:ring-indigo-500" %>
<% field_classes = lambda do |attributes, *extra_classes|
     attrs = Array(attributes)
     classes = [input_classes] + extra_classes
     classes << "ring-red-500 focus:ring-red-500" if attrs.any? { |attr| module_benefit.errors[attr].present? }
     classes.compact.join(" ")
   end %>
<% default_weighting = begin
     max_weight = ModuleBenefit.where(plan_module_id: plan_version&.plan_module_ids).maximum(:weighting)
     max_weight.nil? ? 0 : max_weight + 1
   end %>
<% limit_type_options = BenefitLimitRule.limit_types.keys.map { |key| [key.humanize, key] } %>
<% scope_options = BenefitLimitRule.scopes.keys.map { |key| [key.humanize, key] } %>
<% format_rule = lambda do |rule|
     limit_text =
       case rule.limit_type
       when "amount"
         [
           ["USD", rule.insurer_amount_usd],
           ["GBP", rule.insurer_amount_gbp],
           ["EUR", rule.insurer_amount_eur]
         ].filter_map do |currency, amount|
           next if amount.blank?
           ["#{currency} #{number_to_currency(amount, unit: "")}".strip, rule.unit].compact.join(" ")
         end.join(" / ")
       when "as_charged"
         "As charged"
       when "not_stated"
         "Not stated"
       end

     cap_text =
       [
         ["USD", rule.cap_insurer_amount_usd],
         ["GBP", rule.cap_insurer_amount_gbp],
         ["EUR", rule.cap_insurer_amount_eur]
       ].filter_map do |currency, amount|
         next if amount.blank?
         ["#{currency} #{number_to_currency(amount, unit: "")}".strip, rule.cap_unit].compact.join(" ")
       end.join(" / ")

     output = limit_text.to_s
     output = "#{output}, up to #{cap_text}" if cap_text.present?
     output = "#{output} (#{rule.notes})" if rule.notes.present?
     output
   end %>

<%= turbo_frame_tag "wizard_step" do %>
  <div class="space-y-6">
    <div>
      <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Step 7: Module benefits</h2>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">Attach benefits to each module, define coverage detail, and add benefit limit rules.</p>
    </div>

    <% has_errors = (module_benefit.respond_to?(:errors) && module_benefit.errors.any?) || progress.errors.any? %>
    <% if has_errors %>
      <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700 shadow-xs dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-200">
        <p class="font-semibold">We couldn't save this module benefit</p>
        <ul class="mt-2 list-disc space-y-1 pl-4">
          <% if module_benefit.respond_to?(:errors) && module_benefit.errors.any? %>
            <% module_benefit.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          <% end %>
          <% progress.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with model: module_benefit,
                  scope: :benefits,
                  url: wizard_progress_path(progress),
                  method: :patch,
                  data: { turbo_frame: "wizard_step" },
                  local: true,
                  html: { class: "space-y-6" } do |form| %>
      <%= form.hidden_field :id if module_benefit.persisted? %>
      <div class="space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-white/10 dark:bg-gray-900">
        <% if available_modules.empty? %>
          <div class="rounded-lg border border-dashed border-gray-300 bg-gray-50 px-4 py-3 text-sm text-gray-600 dark:border-white/20 dark:bg-gray-800 dark:text-gray-200">
            Add at least one plan module before attaching benefits.
          </div>
        <% end %>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <%= form.label :plan_module_id, "Module", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.collection_select :plan_module_id,
                                         available_modules,
                                         :id,
                                         ->(m) { [m.module_group&.name, m.name].compact.join(" – ") },
                                         { prompt: available_modules.empty? ? "No modules available" : "Select a module" },
                                         class: field_classes.call(:plan_module),
                                         disabled: available_modules.empty?,
                                         data: { test_id: "module-field" } %>
            </div>
          </div>

          <div>
            <%= form.label :benefit_id, "Benefit", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.collection_select :benefit_id,
                                         available_benefits,
                                         :id,
                                         ->(benefit) { "#{benefit.name} (#{benefit.coverage_category.name})" },
                                         { prompt: "Select a benefit" },
                                         class: field_classes.call(:benefit),
                                         data: { test_id: "benefit-field" } %>
            </div>
          </div>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <%= form.label :coverage_description, "Coverage description", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.text_area :coverage_description, class: field_classes.call(:coverage_description, "min-h-[90px]"), placeholder: "Describe the coverage or conditions", data: { test_id: "coverage-description-field" } %>
            </div>
          </div>

          <div>
            <%= form.label :waiting_period_months, "Waiting period (months, optional)", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.number_field :waiting_period_months, class: field_classes.call(:waiting_period_months), min: 0, step: 1 %>
            </div>
          </div>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <%= form.label :interaction_type, "Interaction type", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.select :interaction_type,
                              ModuleBenefit.interaction_types.keys.map { |key| [key.humanize, key] },
                              {},
                              class: field_classes.call(:interaction_type),
                              data: { test_id: "interaction-type-field" } %>
            </div>
          </div>

          <div>
            <%= form.label :weighting, "Weighting", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.number_field :weighting,
                                    value: module_benefit.weighting || default_weighting,
                                    class: field_classes.call(:weighting),
                                    min: 0 %>
            </div>
          </div>
        </div>

        <div class="space-y-3 rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-white/10 dark:bg-gray-800/50" data-controller="benefit-limit-rules">
          <div class="flex items-center justify-between gap-3">
            <div>
              <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">Benefit limits</h3>
              <p class="text-xs text-gray-600 dark:text-gray-300">All numeric limits must be represented as benefit limit rules.</p>
            </div>
            <button type="button"
                    data-action="benefit-limit-rules#addRow"
                    class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-3 py-2 text-xs font-semibold text-white shadow-xs transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:bg-indigo-500 dark:hover:bg-indigo-400"
                    data-test-id="add-benefit-limit-rule-button">
              Add limit rule
            </button>
          </div>

          <template data-benefit-limit-rules-target="template">
            <%= form.fields_for :benefit_limit_rules, BenefitLimitRule.new(limit_type: :amount, scope: :benefit_level), child_index: "NEW_RECORD" do |rule_form| %>
              <%= render "wizard_progresses/steps/plan_creation/benefit_limit_rule_fields",
                         rule_form: rule_form,
                         field_input_classes: input_classes,
                         limit_type_options: limit_type_options,
                         scope_options: scope_options %>
            <% end %>
          </template>

          <div class="space-y-3" data-benefit-limit-rules-target="container">
            <%= form.fields_for :benefit_limit_rules do |rule_form| %>
              <%= render "wizard_progresses/steps/plan_creation/benefit_limit_rule_fields",
                         rule_form: rule_form,
                         field_input_classes: input_classes,
                         limit_type_options: limit_type_options,
                         scope_options: scope_options %>
            <% end %>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-3 border-t border-gray-200 pt-6 sm:flex-row sm:items-center sm:justify-between dark:border-white/10">
        <div class="flex gap-3">
          <%= button_tag "← Back",
                         name: "step_action",
                         value: "previous",
                         class: "inline-flex items-center gap-1 rounded-md border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:border-white/10 dark:text-gray-200 dark:hover:bg-white/10 dark:focus:ring-indigo-500" %>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <%= button_tag(module_benefit.persisted? ? "Update module benefit" : "Add module benefit",
                         name: "step_action",
                         value: "add",
                         class: "inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-xs transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-gray-300 disabled:text-gray-600 dark:disabled:bg-gray-700 dark:disabled:text-gray-400 dark:bg-indigo-500 dark:hover:bg-indigo-400",
                         disabled: available_modules.empty?,
                         data: { test_id: "add-module-benefit-button" }) %>
          <%= button_tag "Save and continue →",
                         name: "step_action",
                         value: "next",
                         class: "inline-flex items-center gap-2 rounded-md border border-transparent px-4 py-2 text-sm font-semibold text-indigo-700 bg-indigo-50 shadow-xs hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:bg-indigo-600/20 dark:text-indigo-100 dark:hover:bg-indigo-600/30",
                         data: { test_id: "next-step-button" } %>
        </div>
      </div>
    <% end %>

    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Module benefits added</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400"><%= pluralize(existing_benefits.size, "benefit") %></p>
      </div>

      <% if existing_benefits.empty? %>
        <div class="rounded-lg border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 shadow-xs dark:border-white/20 dark:bg-gray-900 dark:text-gray-300">
          No module benefits yet. Add your first benefit to continue.
        </div>
      <% else %>
        <div class="space-y-6">
          <% available_modules.each do |mod| %>
            <% module_benefits = grouped_benefits[mod.id] || [] %>
            <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm dark:border-white/10 dark:bg-gray-900">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Module</p>
                  <p class="text-base font-semibold text-gray-900 dark:text-gray-100"><%= [mod.module_group&.name, mod.name].compact.join(" · ") %></p>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400"><%= pluralize(module_benefits.size, "benefit") %></p>
              </div>

              <% if module_benefits.empty? %>
                <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">No benefits added yet for this module.</p>
              <% else %>
                <div class="mt-4 grid gap-4 sm:grid-cols-2">
                  <% module_benefits.each do |mb| %>
                    <% benefit_level_rules = mb.benefit_limit_rules.benefit_level %>
                    <% itemised_rules = mb.benefit_limit_rules.itemised %>
                    <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm dark:border-white/10 dark:bg-gray-900">
                      <div class="flex items-start justify-between gap-3">
                        <div class="space-y-1">
                          <p class="text-base font-semibold text-gray-900 dark:text-gray-100"><%= mb.benefit.name %></p>
                          <p class="text-sm text-gray-600 dark:text-gray-300"><%= mb.benefit.coverage_category.name %></p>
                          <% if mb.benefit_limit_group.present? %>
                            <p class="text-xs font-semibold text-indigo-700 dark:text-indigo-200">Shared limit: <%= mb.benefit_limit_group.name %></p>
                          <% end %>
                        </div>
                        <div class="flex items-center gap-3">
                          <%= button_to "Edit",
                                        wizard_progress_path(progress),
                                        method: :patch,
                                        params: { step_action: "edit", benefits: { id: mb.id } },
                                        form: { data: { turbo_frame: "wizard_step" } },
                                        class: "text-sm font-semibold text-indigo-600 hover:text-indigo-500 dark:text-indigo-300 dark:hover:text-indigo-200",
                                        data: { test_id: "edit-module-benefit-#{mb.id}-button" } %>
                          <%= button_to "Delete",
                                        wizard_progress_path(progress),
                                        method: :patch,
                                        params: { step_action: "delete", benefits: { id: mb.id } },
                                        form: { data: { turbo_frame: "wizard_step" } },
                                        class: "text-sm font-semibold text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300",
                                        data: { turbo_confirm: "Delete this module benefit and any linked limits or cost shares?", test_id: "delete-module-benefit-#{mb.id}-button" } %>
                        </div>
                      </div>

                      <% if mb.coverage_description.present? %>
                        <p class="mt-3 text-sm text-gray-700 dark:text-gray-200"><%= mb.coverage_description %></p>
                      <% end %>

                      <% benefit_level_rules.each do |rule| %>
                        <p class="mt-2 text-xs text-gray-600 dark:text-gray-300"><%= format_rule.call(rule) %></p>
                      <% end %>

                      <% if itemised_rules.any? %>
                        <div class="mt-3 rounded-lg bg-gray-50 p-3 text-xs text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                          <p class="font-semibold">Itemised limits</p>
                          <% itemised_rules.each do |rule| %>
                            <p class="mt-1"><span class="font-semibold"><%= rule.name %>:</span> <%= format_rule.call(rule) %></p>
                          <% end %>
                        </div>
                      <% end %>

                      <% if mb.waiting_period_months.present? %>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Waiting period: <%= pluralize(mb.waiting_period_months, "month") %></p>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
