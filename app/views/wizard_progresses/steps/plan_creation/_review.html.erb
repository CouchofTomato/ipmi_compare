<% plan = progress.subject %>
<% module_groups = plan.module_groups.order(:position, :created_at) %>
<% plan_modules = plan.plan_modules.includes(:module_group).order(:created_at) %>
<% module_benefits = ModuleBenefit.where(plan_module_id: plan.plan_module_ids).includes(:benefit, :coverage_category, :benefit_limit_group, plan_module: :module_group).order(:plan_module_id, :weighting, :created_at) %>
<% limit_groups = BenefitLimitGroup.where(plan_module_id: plan.plan_module_ids).includes(plan_module: :module_group).order(:created_at) %>
<% plan_cost_shares = plan.cost_shares.order(:created_at) %>
<% module_cost_shares = plan.plan_modules.includes(:module_group, :cost_shares).order(:created_at) %>
<% module_benefit_cost_shares = ModuleBenefit.where(plan_module_id: plan.plan_module_ids).includes(:benefit, :coverage_category, :cost_shares, plan_module: :module_group).order(:plan_module_id, :weighting, :created_at) %>
<% display_cost_share_amount = lambda do |cs|
     if cs.unit == "percent"
       "#{cs.amount.to_f}%"
     else
       number_to_currency(cs.amount || 0, unit: cs.currency.presence || "$")
     end
   end %>

<%= turbo_frame_tag "wizard_step" do %>
  <div class="space-y-6">
    <div>
      <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Step 9: Review & publish</h2>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">Confirm the plan details, modules, benefits, and cost shares. Finish to mark the plan as published.</p>
    </div>

    <% if progress.errors.any? %>
      <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700 shadow-xs dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-200">
        <p class="font-semibold">We couldn't finish the plan</p>
        <ul class="mt-2 list-disc space-y-1 pl-4">
          <% progress.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="grid gap-4 lg:grid-cols-3">
      <div class="lg:col-span-2 space-y-4">
        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm dark:border-white/10 dark:bg-gray-900">
          <div class="flex items-start justify-between gap-4">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Plan</p>
              <p class="text-lg font-semibold text-gray-900 dark:text-gray-100"><%= plan.name %></p>
              <p class="text-sm text-gray-600 dark:text-gray-300"><%= plan.insurer.name %> · <%= plan.policy_type.humanize %> · <%= plan.version_year %></p>
            </div>
            <% if plan.published? %>
              <span class="inline-flex items-center rounded-full bg-green-50 px-3 py-1 text-xs font-semibold text-green-700 dark:bg-green-600/20 dark:text-green-100">Published</span>
            <% else %>
              <span class="inline-flex items-center rounded-full bg-yellow-50 px-3 py-1 text-xs font-semibold text-yellow-700 dark:bg-yellow-600/20 dark:text-yellow-100">Draft</span>
            <% end %>
          </div>
          <div class="mt-3 grid gap-3 sm:grid-cols-2">
            <div class="rounded-md bg-gray-50 p-3 text-xs text-gray-700 dark:bg-gray-800 dark:text-gray-200">
              <p class="font-semibold text-gray-900 dark:text-gray-100">Residency</p>
              <p class="mt-1"><%= plan.plan_residency_eligibilities.pluck(:country_code).presence&.join(", ") || "Not set" %></p>
            </div>
            <div class="rounded-md bg-gray-50 p-3 text-xs text-gray-700 dark:bg-gray-800 dark:text-gray-200">
              <p class="font-semibold text-gray-900 dark:text-gray-100">Geographic coverage</p>
              <p class="mt-1"><%= plan.geographic_cover_areas.pluck(:name).presence&.join(", ") || "Not set" %></p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm dark:border-white/10 dark:bg-gray-900 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Modules</p>
              <p class="text-sm text-gray-600 dark:text-gray-300"><%= pluralize(plan_modules.size, "module") %> across <%= pluralize(module_groups.size, "group") %></p>
            </div>
          </div>
          <div class="grid gap-3 md:grid-cols-2">
            <% plan_modules.each do |mod| %>
              <div class="rounded-md border border-gray-200 bg-gray-50 p-3 text-sm text-gray-800 dark:border-white/10 dark:bg-gray-800 dark:text-gray-200">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400"><%= mod.module_group&.name || "Ungrouped" %></p>
                <p class="font-semibold text-gray-900 dark:text-gray-100"><%= mod.name %></p>
                <% if mod.is_core? %>
                  <span class="mt-1 inline-flex items-center rounded-full bg-indigo-50 px-2 py-0.5 text-[11px] font-semibold text-indigo-700 dark:bg-indigo-600/20 dark:text-indigo-100">Core</span>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm dark:border-white/10 dark:bg-gray-900 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Module benefits</p>
              <p class="text-sm text-gray-600 dark:text-gray-300"><%= pluralize(module_benefits.size, "benefit") %></p>
            </div>
          </div>
          <div class="grid gap-3 md:grid-cols-2">
            <% module_benefits.each do |mb| %>
              <div class="rounded-md border border-gray-200 bg-gray-50 p-3 text-sm text-gray-800 dark:border-white/10 dark:bg-gray-800 dark:text-gray-200">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400"><%= [mb.plan_module.module_group&.name, mb.plan_module.name].compact.join(" · ") %></p>
                <p class="font-semibold text-gray-900 dark:text-gray-100"><%= mb.benefit.name %></p>
                <p class="text-xs text-gray-600 dark:text-gray-300"><%= mb.coverage_category.name %></p>
                <% if mb.benefit_limit_group.present? %>
                  <p class="text-[11px] text-indigo-700 dark:text-indigo-200">Shared limit: <%= mb.benefit_limit_group.name %></p>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm dark:border-white/10 dark:bg-gray-900 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Benefit limit groups</p>
              <p class="text-sm text-gray-600 dark:text-gray-300"><%= pluralize(limit_groups.size, "group") %></p>
            </div>
          </div>
          <div class="grid gap-3 md:grid-cols-2">
            <% limit_groups.each do |group| %>
              <div class="rounded-md border border-gray-200 bg-gray-50 p-3 text-sm text-gray-800 dark:border-white/10 dark:bg-gray-800 dark:text-gray-200">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400"><%= [group.plan_module.module_group&.name, group.plan_module.name].compact.join(" · ") %></p>
                <p class="font-semibold text-gray-900 dark:text-gray-100"><%= group.name %></p>
                <p class="text-xs text-gray-600 dark:text-gray-300"><%= group.limit_unit %></p>
              </div>
            <% end %>
          </div>
        </div>

        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm dark:border-white/10 dark:bg-gray-900 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Cost shares</p>
              <% total_cost_shares = plan_cost_shares.size + module_cost_shares.sum { |m| m.cost_shares.size } + module_benefit_cost_shares.sum { |mb| mb.cost_shares.size } %>
              <p class="text-sm text-gray-600 dark:text-gray-300"><%= pluralize(total_cost_shares, "cost share") %></p>
            </div>
          </div>
          <div class="space-y-3 text-sm text-gray-800 dark:text-gray-200">
            <% if plan_cost_shares.any? %>
              <div class="rounded-md border border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Plan</p>
                <ul class="mt-2 space-y-1">
                  <% plan_cost_shares.each do |cs| %>
                    <li><%= cs.cost_share_type.humanize %> — <%= display_cost_share_amount.call(cs) %> (<%= cs.per.humanize %>)</li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <% module_cost_shares.each do |mod| %>
              <% next if mod.cost_shares.empty? %>
              <div class="rounded-md border border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400"><%= [mod.module_group&.name, mod.name].compact.join(" · ") %></p>
                <ul class="mt-2 space-y-1">
                  <% mod.cost_shares.each do |cs| %>
                    <li><%= cs.cost_share_type.humanize %> — <%= display_cost_share_amount.call(cs) %> (<%= cs.per.humanize %>)</li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <% module_benefit_cost_shares.each do |mb| %>
              <% next if mb.cost_shares.empty? %>
              <div class="rounded-md border border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400"><%= [mb.plan_module.module_group&.name, mb.plan_module.name].compact.join(" · ") %></p>
                <p class="text-xs text-gray-600 dark:text-gray-300"><%= mb.benefit.name %> (<%= mb.coverage_category.name %>)</p>
                <ul class="mt-2 space-y-1">
                  <% mb.cost_shares.each do |cs| %>
                    <li><%= cs.cost_share_type.humanize %> — <%= display_cost_share_amount.call(cs) %> (<%= cs.per.humanize %>)</li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      </div>

    </div>
  </div>
<% end %>

<div class="mt-6 space-y-4">
  <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm dark:border-white/10 dark:bg-gray-900">
    <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">Publish plan</h3>
    <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">Mark the plan as published to make it available.</p>

    <%= form_with url: wizard_progress_path(progress),
                  method: :patch,
                  local: true,
                  html: { class: "space-y-4 mt-4" } do |form| %>
      <div class="flex items-center gap-2">
        <%= form.check_box :publish_now, { checked: true, name: "review[publish_now]", class: "h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" }, "1", "0" %>
        <%= form.label :publish_now, "Publish this plan now", class: "text-sm text-gray-900 dark:text-gray-100" %>
      </div>

      <div class="flex flex-col gap-3 border-t border-gray-200 pt-4 dark:border-white/10">
        <%= button_tag "Finish and publish",
                       name: "step_action",
                       value: "complete",
                       class: "inline-flex items-center justify-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-xs transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:bg-indigo-500 dark:hover:bg-indigo-400" %>
      </div>
    <% end %>
  </div>
</div>
