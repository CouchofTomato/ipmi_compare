<% plan = progress.subject %>
<% plan_version = progress.plan_version || plan&.current_plan_version %>
<% benefit_limit_group = local_assigns[:resource].is_a?(BenefitLimitGroup) ? local_assigns[:resource] : BenefitLimitGroup.new %>
<% available_modules = plan_version&.plan_modules&.left_joins(:module_group)&.includes(:module_group)&.order("module_groups.position ASC", "plan_modules.created_at ASC") || [] %>
<% available_module_benefits = ModuleBenefit.where(plan_module_id: Array(plan_version&.plan_module_ids)).includes(benefit: :coverage_category, plan_module: :module_group).order("module_benefits.plan_module_id ASC", "module_benefits.weighting ASC", "module_benefits.created_at ASC") %>
<% existing_groups = BenefitLimitGroup.where(plan_module_id: Array(plan_version&.plan_module_ids)).includes(plan_module: :module_group).order(:created_at) %>
<% grouped_module_benefits = ModuleBenefit.where(benefit_limit_group_id: existing_groups.map(&:id)).includes(benefit: :coverage_category, plan_module: :module_group).group_by(&:benefit_limit_group_id) %>
<% input_classes = "block w-full rounded-md border-0 bg-white px-3 py-2 text-base text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:ring-white/10 dark:placeholder:text-gray-500 dark:focus:ring-indigo-500" %>
<% field_classes = lambda do |attributes, *extra_classes|
     attrs = Array(attributes)
     classes = [input_classes] + extra_classes
     classes << "ring-red-500 focus:ring-red-500" if attrs.any? { |attr| benefit_limit_group.errors[attr].present? }
     classes.compact.join(" ")
   end %>
<% selected_module_benefit_ids = Array(benefit_limit_group.module_benefit_ids).map(&:to_i) %>

<%= turbo_frame_tag "wizard_step" do %>
  <div class="space-y-6">
    <div>
      <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Step 8: Benefit limit groups</h2>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">Create shared limits that apply to multiple module benefits within the same module.</p>
    </div>

    <% has_errors = (benefit_limit_group.respond_to?(:errors) && benefit_limit_group.errors.any?) || progress.errors.any? %>
    <% if has_errors %>
      <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700 shadow-xs dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-200">
        <p class="font-semibold">We couldn't save this benefit limit group</p>
        <ul class="mt-2 list-disc space-y-1 pl-4">
          <% if benefit_limit_group.respond_to?(:errors) && benefit_limit_group.errors.any? %>
            <% benefit_limit_group.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          <% end %>
          <% progress.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with model: benefit_limit_group,
                  scope: :benefit_limit_groups,
                  url: wizard_progress_path(progress),
                  method: :patch,
                  data: { turbo_frame: "wizard_step" },
                  local: true,
                  html: { class: "space-y-6" } do |form| %>
      <div class="space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-white/10 dark:bg-gray-900">
        <% if available_module_benefits.empty? %>
          <div class="rounded-lg border border-dashed border-gray-300 bg-gray-50 px-4 py-3 text-sm text-gray-600 dark:border-white/20 dark:bg-gray-800 dark:text-gray-200">
            Add module benefits first, then return here to group them under a shared limit.
          </div>
        <% end %>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <%= form.label :plan_module_id, "Module", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.collection_select :plan_module_id,
                                         available_modules,
                                         :id,
                                         ->(m) { [m.module_group&.name, m.name].compact.join(" – ") },
                                         { prompt: available_modules.empty? ? "No modules available" : "Select a module" },
                                         class: field_classes.call(:plan_module),
                                         disabled: available_modules.empty?,
                                         data: { test_id: "module-field" } %>
            </div>
            <% if benefit_limit_group.errors[:plan_module].present? || benefit_limit_group.errors[:plan_module_id].present? %>
              <p class="mt-2 text-sm text-red-600 dark:text-red-400"><%= (benefit_limit_group.errors[:plan_module] + benefit_limit_group.errors[:plan_module_id]).uniq.to_sentence %></p>
            <% end %>
          </div>

          <div>
            <%= form.label :name, "Limit group name", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.text_field :name, class: field_classes.call(:name), placeholder: "e.g. Annual outpatient therapies limit", data: { test_id: "limit-group-name-field" } %>
            </div>
            <% if benefit_limit_group.errors[:name].present? %>
              <p class="mt-2 text-sm text-red-600 dark:text-red-400"><%= benefit_limit_group.errors[:name].to_sentence %></p>
            <% end %>
          </div>
        </div>

        <div class="grid gap-4 sm:grid-cols-3">
          <div>
            <%= form.label :limit_usd, "Limit (USD)", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.number_field :limit_usd, class: field_classes.call(:limit_usd), step: 0.01, min: 0, data: { test_id: "limit-usd-field" } %>
            </div>
          </div>
          <div>
            <%= form.label :limit_gbp, "Limit (GBP)", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.number_field :limit_gbp, class: field_classes.call(:limit_gbp), step: 0.01, min: 0 %>
            </div>
          </div>
          <div>
            <%= form.label :limit_eur, "Limit (EUR)", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.number_field :limit_eur, class: field_classes.call(:limit_eur), step: 0.01, min: 0 %>
            </div>
          </div>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <%= form.label :limit_unit, "Limit unit", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.text_field :limit_unit, class: field_classes.call(:limit_unit), placeholder: "e.g. per policy / per year", data: { test_id: "limit-unit-field" } %>
            </div>
            <% if benefit_limit_group.errors[:limit_unit].present? %>
              <p class="mt-2 text-sm text-red-600 dark:text-red-400"><%= benefit_limit_group.errors[:limit_unit].to_sentence %></p>
            <% end %>
          </div>

          <div>
            <%= form.label :notes, "Notes (optional)", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
            <div class="mt-2">
              <%= form.text_area :notes, class: field_classes.call(:notes, "min-h-[90px]"), placeholder: "Add any context about how this shared limit applies." %>
            </div>
          </div>
        </div>

        <div>
          <%= form.label :module_benefit_ids, "Module benefits using this limit", class: "text-sm font-medium text-gray-900 dark:text-gray-100" %>
          <div class="mt-2">
            <% if available_module_benefits.empty? %>
              <div class="rounded-md border border-dashed border-gray-300 bg-gray-50 px-4 py-3 text-sm text-gray-600 dark:border-white/20 dark:bg-gray-800 dark:text-gray-200">
                No module benefits available yet.
              </div>
            <% else %>
              <%= form.collection_select :module_benefit_ids,
                                         available_module_benefits,
                                         :id,
                                         ->(mb) { "#{[mb.plan_module.module_group&.name, mb.plan_module.name].compact.join(" · ")} — #{mb.benefit.name} (#{mb.benefit.coverage_category.name})" },
                                         { selected: selected_module_benefit_ids },
                                         class: field_classes.call(:module_benefit_ids, "min-h-[140px]"),
                                         multiple: true,
                                         size: 8,
                                         data: { test_id: "module-benefits-field" } %>
            <% end %>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-3 border-t border-gray-200 pt-6 sm:flex-row sm:items-center sm:justify-between dark:border-white/10">
        <div class="flex gap-3">
          <%= button_tag "← Back",
                         name: "step_action",
                         value: "previous",
                         class: "inline-flex items-center gap-1 rounded-md border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:border-white/10 dark:text-gray-200 dark:hover:bg-white/10 dark:focus:ring-indigo-500" %>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <%= button_tag "Add benefit limit group",
                         name: "step_action",
                         value: "add",
                         class: "inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-xs transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-gray-300 disabled:text-gray-600 dark:disabled:bg-gray-700 dark:disabled:text-gray-400 dark:bg-indigo-500 dark:hover:bg-indigo-400",
                         disabled: available_module_benefits.empty?,
                         data: { test_id: "add-benefit-limit-group-button" } %>
          <%= button_tag "Save and continue →",
                         name: "step_action",
                         value: "next",
                         class: "inline-flex items-center gap-2 rounded-md border border-transparent px-4 py-2 text-sm font-semibold text-indigo-700 bg-indigo-50 shadow-xs hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 dark:bg-indigo-600/20 dark:text-indigo-100 dark:hover:bg-indigo-600/30",
                         data: { test_id: "next-step-button" } %>
        </div>
      </div>
    <% end %>

    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Benefit limit groups added</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400"><%= pluralize(existing_groups.size, "group") %></p>
      </div>

      <% if existing_groups.empty? %>
        <div class="rounded-lg border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 shadow-xs dark:border-white/20 dark:bg-gray-900 dark:text-gray-300">
          No limit groups yet. Add one to connect related benefits under a shared limit.
        </div>
      <% else %>
        <div class="space-y-3">
          <% existing_groups.each do |group| %>
            <% module_benefits_for_group = grouped_module_benefits[group.id] || [] %>
            <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm dark:border-white/10 dark:bg-gray-900">
              <div class="flex items-start justify-between gap-3">
                <div class="space-y-1">
                  <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">
                    <%= [group.plan_module.module_group&.name, group.plan_module.name].compact.join(" · ") %>
                  </p>
                  <p class="text-base font-semibold text-gray-900 dark:text-gray-100"><%= group.name %></p>
                  <p class="text-xs text-gray-500 dark:text-gray-400"><%= group.limit_unit %></p>
                </div>
                <div>
                  <%= button_to "Delete",
                                wizard_progress_path(progress),
                                method: :patch,
                                params: { step_action: "delete", benefit_limit_groups: { id: group.id } },
                                form: { data: { turbo_frame: "wizard_step" } },
                                class: "text-sm font-semibold text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300",
                                data: { turbo_confirm: "Delete this benefit limit group and all linked module benefits and cost shares?", test_id: "delete-benefit-limit-group-#{group.id}-button" } %>
                </div>
              </div>

              <% if group.notes.present? %>
                <p class="mt-3 text-sm text-gray-700 dark:text-gray-200"><%= group.notes %></p>
              <% end %>

              <% if group.limit_usd.present? || group.limit_gbp.present? || group.limit_eur.present? %>
                <div class="mt-3 rounded-lg bg-gray-50 p-3 text-xs text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                  <% if group.limit_usd.present? %>
                    <p><span class="font-semibold">USD:</span> <%= number_to_currency(group.limit_usd, unit: "$") %></p>
                  <% end %>
                  <% if group.limit_gbp.present? %>
                    <p><span class="font-semibold">GBP:</span> <%= number_to_currency(group.limit_gbp, unit: "£") %></p>
                  <% end %>
                  <% if group.limit_eur.present? %>
                    <p><span class="font-semibold">EUR:</span> <%= number_to_currency(group.limit_eur, unit: "€") %></p>
                  <% end %>
                  <p><span class="font-semibold">Unit:</span> <%= group.limit_unit %></p>
                </div>
              <% end %>

              <% if module_benefits_for_group.any? %>
                <div class="mt-3 space-y-1">
                  <p class="text-xs font-semibold text-gray-700 dark:text-gray-200">Module benefits</p>
                  <ul class="space-y-1 text-sm text-gray-700 dark:text-gray-200">
                    <% module_benefits_for_group.each do |mb| %>
                      <li class="flex items-center gap-2">
                        <span class="inline-flex h-2 w-2 rounded-full bg-indigo-500"></span>
                        <span><%= "#{mb.benefit.name} (#{mb.benefit.coverage_category.name})" %></span>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
